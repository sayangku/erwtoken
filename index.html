import json
import sqlite3
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# Sabitler
TREES = ['ğŸŒ³', 'ğŸŒ´', 'ğŸŒ²', 'ğŸŒ¿', 'ğŸƒ']
RARE_TREES = ['ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ¥¥', 'ğŸŒº']

# VeritabanÄ± baÄŸlantÄ±sÄ±
conn = sqlite3.connect('ecoreward.db')
c = conn.cursor()

# Tablo oluÅŸtur
c.execute('''CREATE TABLE IF NOT EXISTS players
             (user_id INTEGER PRIMARY KEY, points INTEGER, level INTEGER, erw_tokens INTEGER, forest_size INTEGER)''')
conn.commit()

def get_player_data(user_id):
    c.execute("SELECT * FROM players WHERE user_id = ?", (user_id,))
    data = c.fetchone()
    if data:
        return {
            'points': data[1],
            'level': data[2],
            'erw_tokens': data[3],
            'forest_size': data[4]
        }
    return None

def update_player_data(user_id, points, level, erw_tokens, forest_size):
    c.execute("""INSERT OR REPLACE INTO players (user_id, points, level, erw_tokens, forest_size)
                 VALUES (?, ?, ?, ?, ?)""", (user_id, points, level, erw_tokens, forest_size))
    conn.commit()

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    player_data = get_player_data(user_id)

    if not player_data:
        player_data = {
            'points': 0,
            'level': 1,
            'erw_tokens': 0,
            'forest_size': 0
        }
        update_player_data(user_id, **player_data)

    # Verileri WebApp'e parametre olarak gÃ¶nderiyoruz
    web_app = WebAppInfo(url=f"https://sayangku.github.io/erwtoken/?points={player_data['points']}&level={player_data['level']}&erwTokens={player_data['erw_tokens']}&forestSize={player_data['forest_size']}")
    keyboard = [[InlineKeyboardButton("Oyunu BaÅŸlat", web_app=web_app)]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    message = (
        f"ğŸŒ EcoReward Orman Oyunu'na hoÅŸ geldiniz!\n\n"
        f"Oyunu baÅŸlatmak iÃ§in aÅŸaÄŸÄ±daki butona tÄ±klayÄ±n.\n"
        f"AÄŸaÃ§lara tÄ±klayarak puan kazanÄ±n ve ormanÄ± bÃ¼yÃ¼tÃ¼n!\n"
        f"Nadir aÄŸaÃ§larÄ± ({' '.join(RARE_TREES)}) bulun, ekstra puan kazanÄ±n!\n"
        f"Her 100 puan iÃ§in 1 ERW token alÄ±rsÄ±nÄ±z!\n"
        f"Her 10 ERW token iÃ§in 1 seviye atlarsÄ±nÄ±z!"
    )

    await update.message.reply_text(text=message, reply_markup=reply_markup)

async def handle_webapp_data(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        data = json.loads(update.effective_message.web_app_data.data)
        print(f"Gelen veri: {data}")  # Gelen veriyi yazdÄ±r
        user_id = update.effective_user.id

        points = int(data['points'])
        erw_tokens = int(data['erwTokens'])
        level = int(data['level'])
        forest_size = int(data['forestSize'])

        update_player_data(user_id, points, level, erw_tokens, forest_size)

        message = (
            f"Oyun sonucu gÃ¼ncellendi!\n"
            f"PuanÄ±nÄ±z: {points}\n"
            f"ERW Token: {erw_tokens}\n"
            f"Seviye: {level}\n"
            f"Orman BÃ¼yÃ¼klÃ¼ÄŸÃ¼: {forest_size} ğŸŒ³"
        )
        await update.message.reply_text(message)
    except Exception as e:
        await update.message.reply_text(f"Bir hata oluÅŸtu: {str(e)}")

def main():
    application = Application.builder().token("6977513645:AAHXgoaBI8mWIdbvT-udEY1M6rvLGSGuQNc").build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.StatusUpdate.WEB_APP_DATA, handle_webapp_data))

    application.run_polling()

if __name__ == '__main__':
    print("Bot baÅŸlatÄ±lÄ±yor...")
    main()
    print("Bot durduruldu.")
